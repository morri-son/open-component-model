

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
        description: "Branch to cut to, must match regex releases/v0.[0-9]+"
      component_path:
        required: true
        type: string
        description: "Path to the CLI component, e.g. cli"
      release_candidate:
        required: false
        default: true
        type: boolean
        description: "If true, prepare next RC metadata. If false, prepare final promotion metadata from latest RC."
    outputs:
      new_tag:
        description: "New RC tag name (e.g. cli/v0.1.0-rc.3)"
        value: ${{ jobs.prepare.outputs.new_tag }}
      new_version:
        description: "New RC version (e.g. v0.1.0-rc.3)"
        value: ${{ jobs.prepare.outputs.new_version }}
      base_version:
        description: "Base version (e.g. v0.1.0-rc.1 -> v0.1.0)"
        value: ${{ jobs.prepare.outputs.base_version }}
      promotion_tag:
        description: "Tag to be used for promotion later, eg. cli/v0.1.0-rc.1 -> cli/v0.1.0"
        value: ${{ jobs.prepare.outputs.promotion_tag }}
      latest_rc_tag:
        description: "Latest existing RC tag on the release branch (e.g. cli/v0.1.0-rc.2)"
        value: ${{ jobs.prepare.outputs.latest_rc_tag }}
      latest_rc_version:
        description: "Latest existing RC version on the release branch (e.g. 0.1.0-rc.2)"
        value: ${{ jobs.prepare.outputs.latest_rc_version }}
      latest_promotion_tag:
        description: "Final promotion tag derived from latest RC tag (e.g. cli/v0.1.0)"
        value: ${{ jobs.prepare.outputs.latest_promotion_tag }}
      latest_promotion_version:
        description: "Final promotion version derived from latest RC tag (e.g. 0.1.0)"
        value: ${{ jobs.prepare.outputs.latest_promotion_version }}
      changelog_b64:
        description: "Changelog encoded in base64 for release body"
        value: ${{ jobs.prepare.outputs.changelog_b64 }}

jobs:
  prepare:
    name: Tag & Changelog
    permissions:
      contents: read
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.compute.outputs.new_tag }}
      new_version: ${{ steps.compute.outputs.new_version }}
      base_version: ${{ steps.compute.outputs.base_version }}
      promotion_tag: ${{ steps.compute.outputs.promotion_tag }}
      latest_rc_tag: ${{ steps.latest_rc.outputs.latest_rc_tag }}
      latest_rc_version: ${{ steps.latest_rc.outputs.latest_rc_version }}
      latest_promotion_tag: ${{ steps.latest_rc.outputs.latest_promotion_tag }}
      latest_promotion_version: ${{ steps.latest_rc.outputs.latest_promotion_version }}
      changelog_b64: ${{ steps.summarize.outputs.changelog_b64 }}
    steps:
      # Checkout the repository and target branch
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          sparse-checkout: |
            ${{ inputs.component_path }}
            .github/scripts
          fetch-depth: 0
          ref: ${{ inputs.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # Compute new RC version based on branch and existing tags
      - name: Compute new RC version
        id: compute
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          BRANCH: ${{ inputs.branch }}
          COMPONENT_PATH: ${{ inputs.component_path }}
        with:
          script: |
            const script = await import('${{ github.workspace }}/.github/scripts/compute-rc-version.js');
            await script.default({ core, github, context });

      - name: Resolve latest existing RC on branch
        id: latest_rc
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          BRANCH: ${{ inputs.branch }}
          COMPONENT_PATH: ${{ inputs.component_path }}
        with:
          script: |
            const script = await import('${{ github.workspace }}/.github/scripts/resolve-latest-rc.js');
            await script.default({ core, github, context });

      - name: Generate changelog with git-cliff
        if: ${{ inputs.release_candidate == true }}
        uses: orhun/git-cliff-action@e16f179f0be49ecdfe63753837f20b9531642772 # v4
        id: git-cliff
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          config: ${{ inputs.component_path }}/cliff.toml
          args: |
            --include-path "${{ inputs.component_path }}/**" \
            --tag-pattern "^${{ inputs.component_path }}/v\\d+\\.\\d+\\.\\d+(?:[-\\w\\.]+)?$" \
            --ignore-tags "^${{ inputs.component_path }}/v\\d+\\.\\d+\\.\\d+-rc\\.\\d+$" \
            --tag "${{ steps.compute.outputs.new_tag }}" \
            -o "$RUNNER_TEMP/CHANGELOG.md" \
            --use-branch-tags \
            --latest

      - name: Summarize changelog
        if: ${{ inputs.release_candidate == true }}
        id: summarize
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          CHANGELOG_FILE: ${{ runner.temp }}/CHANGELOG.md
          TAG: ${{ steps.compute.outputs.new_tag }}
        with:
          script: |
            const fs = require("fs");
            const log = fs.existsSync(process.env.CHANGELOG_FILE)
              ? fs.readFileSync(process.env.CHANGELOG_FILE, "utf8").trim()
              : "No changelog.";

            const tag = process.env.TAG || "";
            const repo = process.env.GITHUB_REPOSITORY || "";
            const firstNonEmptyLine = log.split("\n").find((line) => line.trim().length > 0) || "";
            const sectionTitle = firstNonEmptyLine.replace(/^#+\s*/, "").trim();

            let headingText = tag || "release";
            if (sectionTitle) {
              const m = sectionTitle.match(/^\[(.+?)\]\s*-\s*(.+)$/);
              headingText = m ? `${m[1]} - ${m[2]}` : sectionTitle;
            }

            const releaseUrl = repo && tag
              ? `https://github.com/${repo}/releases/tag/${encodeURIComponent(tag)}`
              : "";

            const encoded = Buffer.from(log).toString("base64");
            core.setOutput("changelog_b64", encoded);

            if (releaseUrl) {
              await core.summary
                .addHeading(`Release Notes - ${headingText}`)
                .addLink(releaseUrl, releaseUrl)
                .addEOL()
                .addEOL()
                .addRaw(log)
                .write();
            } else {
              await core.summary
                .addHeading(`Release Notes - ${headingText}`)
                .addRaw(log)
                .write();
            }

      - name: Summarize promotion source release notes
        if: ${{ inputs.release_candidate == false }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          RC_TAG: ${{ steps.latest_rc.outputs.latest_rc_tag }}
        with:
          script: |
            const rcTag = process.env.RC_TAG || "";
            const repo = process.env.GITHUB_REPOSITORY || "";

            if (!rcTag || !repo) {
              await core.summary
                .addHeading("Final Release Notes (promoted from RC)")
                .addRaw("No RC source tag available.")
                .write();
              return;
            }

            await core.summary
              .addHeading(`Final Release Notes (promoted from ${rcTag})`)
              .addRaw('Final release URL will be added in the release publication step.')
              .write();
